<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rony Games</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');
        :root {
            --p1-color: #2196f3; --p2-color: #e91e63; --accent-color: #ff5722;
            --board-color-1: #4fc3f7; --board-color-2: #29b6f6;
            --positive-bg: #c8e6c9; --positive-text: #1b5e20; --positive-border: #4caf50;
            --negative-bg: #ffcdd2; --negative-text: #b71c1c; --negative-border: #f44336;
            --event-bg: #e1bee7; --event-text: #4a148c; --event-border: #9c27b0;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            display: flex; justify-content: flex-start; align-items: center; flex-direction: column;
            margin: 0; padding: 8px; min-height: 100vh; box-sizing: border-box; overflow-y: auto;
        }
        /* --- مؤثرات الاهتزاز والرسوم المتحركة --- */
        body.shake { animation: screen-shake 0.4s ease-in-out; }
        @keyframes screen-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .landing-animation { animation: squash-stretch 0.4s ease-out; }
        @keyframes squash-stretch {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2, 0.8); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        h1.game-title {
            font-family: 'Bangers', cursive; font-size: clamp(28px, 8vw, 40px);
            background: linear-gradient(45deg, #ffd700, #ffeb3b, #ff9800);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin: 8px 0 12px 0; letter-spacing: 2px;
            animation: title-glow 2s ease-in-out infinite alternate;
        }
        @keyframes title-glow {
            0% { filter: drop-shadow(0 0 5px #ffd700); }
            100% { filter: drop-shadow(0 0 15px #ff9800); }
        }
        .game-wrapper { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; }
        .game-container {
            width: 100%; background: linear-gradient(145deg, #ffffff, #f5f5f5);
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 12px; position: relative; border: 3px solid #e0e0e0;
            margin-bottom: 0;
        }
        .game-board {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px;
            aspect-ratio: 6 / 11; background: linear-gradient(145deg, #37474f, #455a64);
            padding: 6px; border-radius: 15px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
        }
        .square {
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            color: #1a1a1a; cursor: pointer; font-family: 'Cairo', sans-serif;
            font-size: clamp(20px, 6vw, 32px); font-weight: 900;
            position: relative; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid transparent; overflow: hidden;
        }
        .square .number { position: relative; z-index: 2; }
        .square:nth-child(odd) { background: linear-gradient(145deg, var(--board-color-1), #26c6da); }
        .square:nth-child(even) { background: linear-gradient(145deg, var(--board-color-2), #0277bd); color: #ffffff; }
        #start-square { background: linear-gradient(145deg, #4caf50, #2e7d32); color: white; font-size: clamp(14px, 4vw, 18px); font-weight: bold; }
        .square.finish { background: linear-gradient(145deg, #ff5722, #d84315); color: white; font-size: clamp(24px, 7vw, 36px); animation: finish-pulse 1.5s ease-in-out infinite; }
        @keyframes finish-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .square.event-square::after {
            content: '?'; font-size: clamp(70px, 20vw, 100px);
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-weight: 900; color: rgba(255, 255, 255, 0.4);
            text-shadow: 0 0 5px rgba(255,255,255,0.5), 0 0 12px var(--negative-border), 0 0 22px var(--negative-border);
            z-index: 1; animation: question-pulse 2s ease-in-out infinite alternate;
        }
        @keyframes question-pulse { from { opacity: 0.5; transform: translate(-50%, -50%) scale(1); } to { opacity: 0.8; transform: translate(-50%, -50%) scale(1.05); } }

        .square.highlight-choice, .square.revealed-event { border: 4px solid var(--accent-color); transform: scale(1.08); box-shadow: 0 0 15px var(--accent-color), 0 4px 8px rgba(0,0,0,0.2); animation: choice-pulse 0.8s ease-in-out infinite alternate; }
        @keyframes choice-pulse { 0% { box-shadow: 0 0 15px var(--accent-color), 0 4px 8px rgba(0,0,0,0.2); } 100% { box-shadow: 0 0 25px var(--accent-color), 0 6px 12px rgba(0,0,0,0.3); } }

        .player {
            width: clamp(45px, 12vw, 60px); height: clamp(45px, 12vw, 60px); position: absolute;
            transition: top 0.3s ease, left 0.3s ease; z-index: 10; transform: translate(-50%, -50%);
            font-size: clamp(32px, 10vw, 48px); display: flex; justify-content: center; align-items: center;
            animation: player-idle 2s ease-in-out infinite;
        }
        #player1 { filter: drop-shadow(0 0 5px var(--p1-color)) drop-shadow(0 0 15px var(--p1-color)) drop-shadow(0 4px 6px rgba(0,0,0,0.4)); }
        #player2 { filter: drop-shadow(0 0 5px var(--p2-color)) drop-shadow(0 0 15px var(--p2-color)) drop-shadow(0 4px 6px rgba(0,0,0,0.4)); }
        @keyframes player-idle { 0% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-50%, -50%) scale(1.05); } }
        .player-shield { font-size: clamp(20px, 6vw, 28px); position: absolute; top: -15px; right: -15px; opacity: 0; transition: all 0.3s; filter: drop-shadow(0 0 5px #ffd700); }
        .player-shield.active { opacity: 1; animation: shield-glow 1s ease-in-out infinite alternate; }
        @keyframes shield-glow { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        #spin-trigger { cursor: pointer; position: absolute; bottom: 18px; left: 50%; transform: translateX(-50%); z-index: 20; }
        #spin-trigger .wheel-icon { font-size: clamp(40px, 10vw, 55px); display: inline-block; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); transition: transform 0.3s ease; }
        #spin-trigger:hover .wheel-icon { transform: scale(1.1) rotate(20deg); }

        .controls { background: linear-gradient(145deg, #ffffff, #f8f9fa); border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-align: center; padding: 15px; width: 100%; border: 2px solid #e9ecef; margin-top: 0; }
        .admin-controls { width: 100%; }
        .admin-controls h3 { margin: 0 0 12px 0; font-size: clamp(16px, 4.5vw, 18px); color: #495057; text-align: center; font-weight: bold; }
        .admin-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; }
        .admin-btn { font-family: 'Cairo', sans-serif; border: none; border-radius: 12px; padding: 12px 8px; font-size: clamp(12px, 3.5vw, 14px); cursor: pointer; background: linear-gradient(145deg, #6c757d, #495057); color: white; transition: all 0.3s; text-align: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .admin-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .admin-btn.active { background: linear-gradient(145deg, #28a745, #1e7e34); animation: btn-active 1s ease-in-out infinite alternate; }
        @keyframes btn-active { 0% { box-shadow: 0 2px 8px rgba(0,0,0,0.2); } 100% { box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); } }
        #admin-win-btn { background: linear-gradient(145deg, #dc3545, #c82333); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; z-index: 100; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); }
        .wheel-container { position: relative; width: 300px; height: 300px; }
        #spinner-arrow { position: absolute; top: 50%; right: -15px; transform: translateY(-50%); width: 0; height: 0; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-right: 30px solid var(--accent-color); z-index: 101; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        #spin-wheel { width: 100%; height: 100%; border-radius: 50%; border: 8px solid #fff; box-shadow: 0 0 25px rgba(0,0,0,0.4); position: relative; overflow: hidden; transition: transform 6s cubic-bezier(0.25, 1, 0.5, 1); }
        .wheel-segment { position: absolute; width: 50%; height: 50%; top: 50%; left: 50%; transform-origin: 0% 0%; display: flex; justify-content: center; align-items: center; color: white; font-weight: 900; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-size: clamp(18px, 5vw, 22px); }
        .popup-content { width: 85%; max-width: 320px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 4px solid; }
        .popup-content.positive { background: linear-gradient(145deg, var(--positive-bg), #a5d6a7); border-color: var(--positive-border); }
        .popup-content.negative { background: linear-gradient(145deg, var(--negative-bg), #ef9a9a); border-color: var(--negative-border); }
        .popup-content.event { background: linear-gradient(145deg, var(--event-bg), #ce93d8); border-color: var(--event-border); }
        .popup-content h2 { margin: 0 0 12px 0; font-size: clamp(20px, 6vw, 24px); font-weight: bold; }
        .popup-content p { margin: 0; font-size: clamp(40px, 12vw, 50px); font-weight: 900; }
        .popup-content.event p { font-size: clamp(16px, 5vw, 20px); font-weight: bold; text-align: right; line-height: 1.8; margin: 10px 0; }
        .popup-content small { display: block; margin-top: 15px; opacity: 0.8; font-size: clamp(12px, 3.5vw, 14px); }
        @keyframes pop-in { 0% { transform: scale(0.3) rotate(-10deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        #team-select-modal .popup-content { background: linear-gradient(145deg, #e0eafc, #d7e3fc); border-color: #667eea; }
        #team-select-modal h2 { color: #3d5afe; }
        .team-select-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .team-select-btn { border: none; border-radius: 15px; padding: 15px 30px; font-family: 'Cairo', sans-serif; font-size: 20px; font-weight: 700; color: white; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .team-select-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        #select-btn-p1 { background: linear-gradient(145deg, var(--p1-color), #1976d2); }
        #select-btn-p2 { background: linear-gradient(145deg, var(--p2-color), #c2185b); }
        #win-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center; z-index: 300; transition: all 0.8s ease; overflow: hidden; background: radial-gradient(circle at center, #1a237e 0%, #0d47a1 50%, #1565c0 100%); }
        #win-screen.winner-p1 { background: radial-gradient(circle at center, #1565c0 0%, #1976d2 50%, #42a5f5 100%); }
        #win-screen.winner-p2 { background: radial-gradient(circle at center, #ad1457 0%, #c2185b 50%, #e91e63 100%); }
        .win-content { text-align: center; z-index: 310; position: relative; animation: win-content-appear 1.2s 0.5s forwards; opacity: 0; transform: scale(0.8); }
        @keyframes win-content-appear { 0% { opacity: 0; transform: scale(0.8) translateY(50px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .celebration-emoji { font-size: clamp(80px, 20vw, 120px); margin-bottom: 20px; animation: celebration-bounce 1s ease-in-out infinite alternate; }
        @keyframes celebration-bounce { 0% { transform: scale(1) rotate(-5deg); } 100% { transform: scale(1.1) rotate(5deg); } }
        .win-text .celebration { font-family: 'Cairo', sans-serif; font-size: clamp(2.5rem, 8vw, 3.5rem); display: block; color: #ffffff; text-shadow: 0 0 20px rgba(255,255,255,0.8); margin-bottom: 10px; font-weight: bold; }
        .win-text .winner-team { font-family: 'Bangers', cursive; display: block; font-size: clamp(4rem, 15vw, 7rem); line-height: 1.1; letter-spacing: 4px; color: #ffd700; text-shadow: 0 0 10px #ffffff, 0 0 20px #ffd700, 0 0 30px #ffd700, 0 0 40px #ffd700, 0 5px 10px rgba(0,0,0,0.5); animation: winner-glow 1.8s ease-in-out infinite alternate; margin-bottom: 30px; }
        @keyframes winner-glow { 0% { text-shadow: 0 0 10px #ffffff, 0 0 20px #ffd700, 0 0 30px #ffd700, 0 0 40px #ffd700, 0 5px 10px rgba(0,0,0,0.5); } 100% { text-shadow: 0 0 20px #ffffff, 0 0 30px #ffd700, 0 0 40px #ffd700, 0 0 50px #ffd700, 0 8px 15px rgba(0,0,0,0.7); } }
        .win-instruction { font-family: 'Cairo', sans-serif; font-size: clamp(18px, 5vw, 24px); color: #ffffff; background: rgba(0,0,0,0.3); padding: 15px 25px; border-radius: 50px; border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); animation: instruction-pulse 2s ease-in-out infinite; cursor: pointer; transition: all 0.3s ease; }
        .win-instruction:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        @keyframes instruction-pulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }
        .firework { position: absolute; width: 6px; height: 6px; border-radius: 50%; opacity: 1; animation: firework-explode 1.5s cubic-bezier(0.1, 1, 0.4, 1) forwards; }
        @keyframes firework-explode { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(40); opacity: 0; } }
        .particle { position: absolute; width: 4px; height: 4px; background: #ffd700; border-radius: 50%; animation: float-particle 3s linear infinite; }
        @keyframes float-particle { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 10% { opacity: 1; transform: translateY(90vh) scale(1); } 90% { opacity: 1; transform: translateY(10vh) scale(1); } 100% { transform: translateY(0vh) scale(0); opacity: 0; } }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <h1 class="game-title">RONY GAMES</h1>
        <div class="game-container">
            <div class="game-board" id="game-board"></div>
            <div id="spin-trigger"><span class="wheel-icon">🎡</span></div>
            <div class="player" id="player1"><span class="player-emoji"></span><div class="player-shield" id="shield1">🛡️</div></div>
            <div class="player" id="player2"><span class="player-emoji"></span><div class="player-shield" id="shield2">🛡️</div></div>
        </div>
        <div class="controls">
            <div class="admin-controls">
                <h3>لوحة التحكم</h3>
                <div class="admin-buttons">
                    <button id="manual-move-btn" class="admin-btn">🕹️ تحريك</button>
                    <button id="admin-shield-btn" class="admin-btn">🛡️ درع</button>
                    <button id="admin-detector-btn" class="admin-btn">🔍 كشف</button>
                    <button id="admin-double-btn" class="admin-btn">💥 مضاعفة</button>
                    <button id="admin-swap-btn" class="admin-btn">🔄 تبديل</button>
                    <button id="admin-win-btn" class="admin-btn">🏆 فوز</button>
                </div>
            </div>
        </div>
    </div>
    <div id="wheel-modal" class="modal"><div class="wheel-container"><div id="spinner-arrow"></div><div id="spin-wheel"></div></div></div>
    <div id="result-popup" class="modal"><div class="popup-content"><h2 id="popup-title"></h2><p id="popup-value"></p><small>اضغط للإغلاق</small></div></div>
    <div id="team-select-modal" class="modal">
        <div class="popup-content">
            <h2>لمن هذا الإجراء؟</h2>
            <div class="team-select-buttons">
                <button id="select-btn-p1" class="team-select-btn">الشباب</button>
                <button id="select-btn-p2" class="team-select-btn">البنات</button>
            </div>
        </div>
    </div>
    <div id="win-screen">
        <div class="win-content">
            <div class="celebration-emoji">🎉</div>
            <div class="win-text">
                <span class="celebration">الفائز هو</span>
                <span class="winner-team"></span>
            </div>
            <div class="win-instruction">اضغط للعب مرة أخرى</div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- قسم إدارة الأصوات ---
        const sounds = {
            ui_click: new Audio('ui_click.mp3'),
            popup_show: new Audio('popup_show.mp3'),
            popup_hide: new Audio('popup_hide.mp3'),
            wheel_spin: new Audio('wheel_spin.mp3'),
            wheel_stop: new Audio('wheel_stop.mp3'),
            player_move: new Audio('player_move.mp3'),
            player_move_back: new Audio('player_move_back.mp3'),
            player_knockback: new Audio('player_knockback.mp3'),
            event_positive: new Audio('event_positive.mp3'),
            event_negative: new Audio('event_negative.mp3'),
            shield_gain: new Audio('shield_gain.mp3'),
            shield_block: new Audio('shield_block.mp3'),
            player_swap: new Audio('player_swap.mp3'),
            game_win: new Audio('game_win.mp3'),
            firework_explode: new Audio('firework_explode.mp3')
        };

        function playSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName].currentTime = 0;
                sounds[soundName].play().catch(e => console.log(`Could not play sound: ${e}`));
            }
        }
        // --- نهاية قسم إدارة الأصوات ---

        const totalSquares = 60;
        const board = document.getElementById('game-board');
        const spinWheel = document.getElementById('spin-wheel');
        const player1El = document.getElementById('player1');
        const player2El = document.getElementById('player2');
        const wheelModal = document.getElementById('wheel-modal');
        const resultPopup = document.getElementById('result-popup');
        const teamSelectModal = document.getElementById('team-select-modal');
        const spinTrigger = document.getElementById('spin-trigger');
        const winScreen = document.getElementById('win-screen');
        let startSquare;
        let playerPositions = { 1: 0, 2: 0 };
        let activePlayer = 1;
        let isActionInProgress = false;
        let currentRotation = 0;
        let squareEvents = {};
        let playerShields = { 1: false, 2: false };
        let playerFlags = { 1: {}, 2: {} };
        const wheelChoices = ["+1", "-1", "+2", "-2", "+3", "-3", "+4", "+5", "+6"];
        const playerEmojis = { 1: { standing: '🧍', walking: '🚶' }, 2: { standing: '🧍‍♀️', walking: '🚶‍♀️' } };
        const gameEvents = [
            { id: 1, title: 'أنت محظوظ!', description: 'تقدم 10 خطوات للأمام.', type: 'positive' }, { id: 2, title: 'عمل جماعي!', description: 'فريقك يتقدم 5 خطوات.', type: 'positive' },
            { id: 3, title: 'مكافأة!', description: 'لف العجلة مرة أخرى.', type: 'neutral' }, { id: 4, title: 'القائد!', description: 'اختر مربعًا من الـ 5 التالية للذهاب إليه.', type: 'neutral' },
            { id: 5, title: 'مضاعفة!', description: 'لف العجلة والنتيجة ستتضاعف.', type: 'neutral' }, { id: 6, title: 'عرقلة!', description: 'أرجع خصمك 5 خطوات للخلف.', type: 'positive' },
            { id: 7, title: 'ضربة قاضية!', description: 'أرجع خصمك 10 خطوات للخلف.', type: 'positive' }, { id: 8, title: 'درع الحماية!', description: 'أنت الآن محصن ضد الحدث السلبي القادم.', type: 'neutral' },
            { id: 9, title: 'خطأ بسيط!', description: 'ارجع 5 خطوات للخلف.', type: 'negative' }, { id: 10, title: 'حظ سيء!', description: 'يا للأسف، ارجع 10 خطوات للخلف.', type: 'negative' },
            { id: 11, title: 'عودة للبـداية!', description: 'حظ أوفر المرة القادمة، ارجع لنقطة البداية.', type: 'negative' }, { id: 12, title: 'تبديل!', description: 'سيتم تبديل أماكن الفريقين.', type: 'neutral' },
            { id: 13, title: 'إقصاء!', description: 'خصمك سيعود إلى نقطة البداية.', type: 'positive' }, { id: 14, title: 'العالم المقلوب!', description: 'لف العجلة والنتيجة ستُطبق بالعكس.', type: 'neutral' }
        ];

        // --- Utils (مع إضافة مؤثرات) ---
        function triggerScreenShake() {
            const body = document.body;
            body.classList.add('shake');
            setTimeout(() => body.classList.remove('shake'), 400);
        }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        function getOpponent(p) { return p === 1 ? 2 : 1; }
        
        function selectTeam() {
            playSound('popup_show');
            return new Promise(resolve => {
                teamSelectModal.style.display = 'flex';
                function handler(e) {
                    playSound('ui_click');
                    const player = e.target.id === 'select-btn-p1' ? 1 : 2;
                    teamSelectModal.removeEventListener('click', modalClickHandler);
                    document.getElementById('select-btn-p1').removeEventListener('click', handler);
                    document.getElementById('select-btn-p2').removeEventListener('click', handler);
                    teamSelectModal.style.display = 'none';
                    resolve(player);
                }
                function modalClickHandler(e) {
                    if (e.target === teamSelectModal) {
                        playSound('popup_hide');
                        teamSelectModal.removeEventListener('click', modalClickHandler);
                        document.getElementById('select-btn-p1').removeEventListener('click', handler);
                        document.getElementById('select-btn-p2').removeEventListener('click', handler);
                        teamSelectModal.style.display = 'none';
                        resolve(null);
                    }
                }
                document.getElementById('select-btn-p1').addEventListener('click', handler, { once: true });
                document.getElementById('select-btn-p2').addEventListener('click', handler, { once: true });
                teamSelectModal.addEventListener('click', modalClickHandler);
            });
        }
        
        // --- UI Functions ---
        function updatePlayerVisual(player, state) { const player1Span = player1El.querySelector('.player-emoji'); const player2Span = player2El.querySelector('.player-emoji'); if (player1Span) player1Span.textContent = playerEmojis[1][player === 1 ? state : 'standing']; if (player2Span) player2Span.textContent = playerEmojis[2][player === 2 ? state : 'standing']; }
        function updateShieldVisual(player) { document.getElementById(`shield${player}`).classList.toggle('active', playerShields[player]); }
        function drawWheel() { spinWheel.innerHTML = ''; const segmentAngle = 360 / wheelChoices.length; const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22', '#1abc9c', '#34495e', '#95a5a6']; let conicGradient = 'conic-gradient('; wheelChoices.forEach((_, i) => { conicGradient += `${colors[i % colors.length]} ${i * segmentAngle}deg ${(i + 1) * segmentAngle}deg, `; }); conicGradient = conicGradient.slice(0, -2) + ')'; spinWheel.style.background = conicGradient; wheelChoices.forEach((choice, i) => { const segment = document.createElement('div'); segment.className = 'wheel-segment'; const textSpan = document.createElement('span'); textSpan.textContent = choice; textSpan.style.transform = `rotate(${segmentAngle / 2}deg) translateY(-150%)`; segment.appendChild(textSpan); segment.style.transform = `rotate(${i * segmentAngle}deg)`; spinWheel.appendChild(segment); }); }
        function showPopup(title, value, typeClass = '') { playSound('popup_show'); const popupContent = resultPopup.querySelector('.popup-content'); popupContent.querySelector('#popup-title').textContent = title; popupContent.querySelector('#popup-value').innerHTML = value; popupContent.className = 'popup-content'; if (typeClass) popupContent.classList.add(typeClass); resultPopup.style.display = 'flex'; }
        function createFloatingParticles() { for (let i = 0; i < 20; i++) { const particle = document.createElement('div'); particle.className = 'particle'; particle.style.left = `${Math.random() * 100}vw`; particle.style.animationDelay = `${Math.random() * 3}s`; particle.style.animationDuration = `${3 + Math.random() * 2}s`; winScreen.appendChild(particle); setTimeout(() => particle.remove(), 8000); } }
        function launchCelebration(winner) {
            const colors = winner === 1 ? ['#3498db', '#2196f3', '#ffffff', '#64b5f6', '#ffd700'] : ['#e91e63', '#f48fb1', '#ffffff', '#f06292', '#ffd700'];
            for (let wave = 0; wave < 3; wave++) {
                setTimeout(() => {
                    for (let i = 0; i < 15; i++) {
                        playSound('firework_explode');
                        const firework = document.createElement('div'); firework.className = 'firework'; firework.style.left = `${Math.random() * 100}vw`; firework.style.top = `${Math.random() * 100}vh`; firework.style.background = colors[Math.floor(Math.random() * colors.length)]; firework.style.animationDelay = `${Math.random() * 0.5}s`; winScreen.appendChild(firework); setTimeout(() => firework.remove(), 2000);
                    }
                }, wave * 800);
            }
            createFloatingParticles();
        }
        function promptToSpin() { wheelModal.style.display = 'flex'; spinWheel.classList.add('ready-to-spin'); }

        // --- Game Setup ---
        function createBoard() { board.innerHTML = ''; let squares = []; for (let i = 1; i <= totalSquares; i++) { const square = document.createElement('div'); square.className = 'square'; square.id = `square-${i}`; const numberSpan = document.createElement('span'); numberSpan.className = 'number'; if (i === totalSquares) { square.classList.add('finish'); numberSpan.textContent = '🏆'; } else { numberSpan.textContent = i; } square.appendChild(numberSpan); squares.push(square); } squares.reverse(); startSquare = document.createElement('div'); startSquare.className = 'square'; startSquare.id = 'start-square'; startSquare.textContent = 'انطلاق'; const emptyDivsCount = 66 - squares.length - 1; for(let i=0; i < emptyDivsCount; i++) { const div = document.createElement('div'); div.style.background = 'transparent'; squares.push(div); } squares.push(startSquare); squares.forEach(sq => board.appendChild(sq)); }
        function distributeEvents() { squareEvents = {}; document.querySelectorAll('.event-square').forEach(el => el.classList.remove('event-square')); let availableSquares = Array.from({length: totalSquares - 1}, (_, i) => i + 1); shuffleArray(availableSquares); const eventSquares = []; const forbidden = new Set(); for (const sq of availableSquares) { if (!forbidden.has(sq)) { eventSquares.push(sq); forbidden.add(sq); forbidden.add(sq - 1); forbidden.add(sq + 1); } if (eventSquares.length >= gameEvents.length) break; } eventSquares.forEach((sqNum, i) => { squareEvents[sqNum] = gameEvents[i]; const sqEl = document.getElementById(`square-${sqNum}`); if(sqEl) sqEl.classList.add('event-square'); }); }
        function setupGame() { createBoard(); playerPositions = { 1: 0, 2: 0 }; playerShields = { 1: false, 2: false }; playerFlags = { 1: {}, 2: {} }; activePlayer = 1; updateShieldVisual(1); updateShieldVisual(2); distributeEvents(); drawWheel(); updatePlayerVisual(0, 'standing'); updatePlayerPosition(1, true); updatePlayerPosition(2, true); }
        
        // --- Movement & Actions ---
        function updatePlayerPosition(player, isInstant = false) {
            const playerEl = (player === 1) ? player1El : player2El;
            playerEl.style.transition = isInstant ? 'none' : 'top 0.3s ease, left 0.3s ease';
            const pos = playerPositions[player];
            let targetElement = (pos <= 0) ? startSquare : document.getElementById(`square-${pos}`);
            if (!targetElement) return;
            const tRect = targetElement.getBoundingClientRect(); const cRect = document.querySelector('.game-container').getBoundingClientRect(); const centerX = tRect.left - cRect.left + tRect.width / 2; const centerY = tRect.top - cRect.top + tRect.height / 2; const offset = (pos <= 0) ? (player === 1 ? -15 : 15) : 0;
            playerEl.style.left = `${centerX + offset}px`; playerEl.style.top = `${centerY}px`;
            
            // إضافة مؤثر الهبوط
            if(!isInstant) {
                playerEl.classList.add('landing-animation');
                setTimeout(() => playerEl.classList.remove('landing-animation'), 400);
            }
        }
        async function movePlayerBy(player, steps) {
            updatePlayerVisual(player, 'walking');
            for (let i = 0; i < Math.abs(steps); i++) {
                let nextPos = playerPositions[player] + Math.sign(steps);
                if (nextPos < 0) nextPos = 0; if (nextPos > totalSquares) nextPos = totalSquares;
                playerPositions[player] = nextPos;
                playSound(steps > 0 ? 'player_move' : 'player_move_back');
                await new Promise(resolve => setTimeout(resolve, 250));
                updatePlayerPosition(player);
            }
            updatePlayerVisual(player, 'standing');
        }
        async function checkKnockBack(currentPlayer) {
            const opponent = getOpponent(currentPlayer); const currentPos = playerPositions[currentPlayer];
            if (currentPos > 0 && currentPos < totalSquares && currentPos === playerPositions[opponent]) {
                playSound('player_knockback'); triggerScreenShake();
                isActionInProgress = true;
                showPopup('إرجاع الخصم!', 'لقد هبطت على نفس مربع خصمك، سيعود 5 خطوات للخلف.', 'event');
                await new Promise(resolve => setTimeout(resolve, 2500));
                await movePlayerBy(opponent, -5);
                resultPopup.style.display = 'none';
                isActionInProgress = false;
            }
        }
        async function showWinScreen(player) {
            if (!player) return;
            playSound('game_win');
            const winnerName = player === 1 ? 'الشباب' : 'البنات';
            winScreen.className = `winner-p${player}`; winScreen.querySelector('.winner-team').textContent = winnerName;
            winScreen.style.display = 'flex';
            launchCelebration(player);
        }
        async function checkWinCondition(player, forceWin = false) { if (forceWin || playerPositions[player] >= totalSquares) { if (!forceWin) playerPositions[player] = totalSquares; updatePlayerPosition(player); await showWinScreen(player); return true; } return false; }
        function switchPlayer() { if (playerFlags[activePlayer]?.extraTurn) { delete playerFlags[activePlayer].extraTurn; return; } }
        async function triggerEvent(player, event) {
            isActionInProgress = true; let movedPlayer = null; let chainedEvent = true;
            if (event.type === 'positive') playSound('event_positive');
            if (event.type === 'negative') playSound('event_negative');
            if (event.id === 12) playSound('player_swap');

            if (event.type === 'negative' && playerShields[player]) {
                playSound('shield_block');
                playerShields[player] = false; updateShieldVisual(player);
                showPopup('تم استخدام الدرع!', 'تم صد الحدث السلبي بنجاح.', 'event');
                await new Promise(resolve => setTimeout(resolve, 2000));
                chainedEvent = false;
            } else {
                showPopup(event.title, event.description, 'event');
                await new Promise(resolve => setTimeout(resolve, 2500));
                switch(event.id) {
                    case 1: await movePlayerBy(player, 10); movedPlayer = player; break;
                    case 2: await movePlayerBy(player, 5); movedPlayer = player; break;
                    case 3: playerFlags[player] = {...playerFlags[player], extraTurn: true }; chainedEvent = false; break;
                    case 4: const options = Array.from({length: 5}, (_, i) => Math.min(playerPositions[player] + i + 1, totalSquares)); options.forEach(sqNum => { const el = document.getElementById(`square-${sqNum}`); if(el) el.classList.add('highlight-choice'); }); const choice = await new Promise(resolve => { const clickHandler = (e) => { const sq = e.target.closest('.square'); if (sq && sq.classList.contains('highlight-choice')) { playSound('ui_click'); const id = parseInt(sq.id.split('-')[1]); board.removeEventListener('click', clickHandler); options.forEach(sqNum => { const el = document.getElementById(`square-${sqNum}`); if(el) el.classList.remove('highlight-choice'); }); resolve(id); } }; board.addEventListener('click', clickHandler); }); playerPositions[player] = choice; updatePlayerPosition(player); movedPlayer = player; break;
                    case 5: playerFlags[player] = {...playerFlags[player], doubleNextSpin: true, extraTurn: true }; chainedEvent = false; break;
                    case 6: await movePlayerBy(getOpponent(player), -5); movedPlayer = getOpponent(player); break;
                    case 7: await movePlayerBy(getOpponent(player), -10); movedPlayer = getOpponent(player); break;
                    case 8: playSound('shield_gain'); playerShields[player] = true; updateShieldVisual(player); chainedEvent = false; break;
                    case 9: await movePlayerBy(player, -5); movedPlayer = player; break;
                    case 10: await movePlayerBy(player, -10); movedPlayer = player; break;
                    case 11: triggerScreenShake(); await movePlayerBy(player, -playerPositions[player]); movedPlayer = player; break;
                    case 12: [playerPositions[1], playerPositions[2]] = [playerPositions[2], playerPositions[1]]; updatePlayerPosition(1); updatePlayerPosition(2); await checkAndTriggerEvent(1); await checkAndTriggerEvent(2); break;
                    case 13: triggerScreenShake(); playerPositions[getOpponent(player)] = 0; updatePlayerPosition(getOpponent(player)); movedPlayer = getOpponent(player); break;
                    case 14: playerFlags[player] = {...playerFlags[player], reverseNextSpin: true, extraTurn: true }; chainedEvent = false; break;
                }
                if (movedPlayer && chainedEvent) { await checkAndTriggerEvent(movedPlayer); }
            }
            resultPopup.style.display = 'none';
            if (!await checkWinCondition(player) && !await checkWinCondition(getOpponent(player))) { isActionInProgress = false; }
        }
        async function checkAndTriggerEvent(player) { const currentPos = playerPositions[player]; if (squareEvents[currentPos]) { const eventToTrigger = squareEvents[currentPos]; document.getElementById(`square-${currentPos}`).classList.remove('event-square'); delete squareEvents[currentPos]; await triggerEvent(player, eventToTrigger); } }
        async function applyWheelResult(result) { let moves = parseInt(result); if (playerFlags[activePlayer]?.doubleNextSpin && moves > 0) { moves *= 2; delete playerFlags[activePlayer].doubleNextSpin; } if (playerFlags[activePlayer]?.reverseNextSpin) { moves *= -1; delete playerFlags[activePlayer].reverseNextSpin; } showPopup(`فريق ${activePlayer === 1 ? 'الشباب' : 'البنات'}`, `${moves > 0 ? '+' : ''}${moves}`, moves > 0 ? 'positive' : 'negative'); await new Promise(resolve => setTimeout(resolve, 1500)); resultPopup.style.display = 'none'; isActionInProgress = true; await movePlayerBy(activePlayer, moves); await checkKnockBack(activePlayer); await checkAndTriggerEvent(activePlayer); isActionInProgress = false; if (!await checkWinCondition(activePlayer)) { } }

        // --- Event Listeners ---
        spinTrigger.addEventListener('click', async () => { if (isActionInProgress) return; playSound('ui_click'); const chosenPlayer = await selectTeam(); if (!chosenPlayer) return; activePlayer = chosenPlayer; promptToSpin(); });
        spinWheel.addEventListener('click', function spinHandler() { if (isActionInProgress || !spinWheel.classList.contains('ready-to-spin')) return; playSound('wheel_spin'); isActionInProgress = true; spinWheel.classList.remove('ready-to-spin'); const targetIndex = Math.floor(Math.random() * wheelChoices.length); const segmentAngle = 360 / wheelChoices.length; const stopAngle = (targetIndex * segmentAngle) + (segmentAngle / 2); currentRotation += (360 * 5) - (currentRotation % 360) - stopAngle; spinWheel.dataset.result = wheelChoices[targetIndex]; spinWheel.style.transform = `rotate(${currentRotation}deg)`; spinWheel.addEventListener('transitionend', function handler() { playSound('wheel_stop'); const resultValue = spinWheel.dataset.result; setTimeout(async () => { wheelModal.style.display = 'none'; await applyWheelResult(resultValue); isActionInProgress = false; }, 500); }, { once: true }); });
        resultPopup.addEventListener('click', () => { playSound('popup_hide'); resultPopup.style.display = 'none'; });
        wheelModal.addEventListener('click', (e) => { if (e.target === wheelModal && !isActionInProgress) { playSound('popup_hide'); wheelModal.style.display = 'none'; } });
        winScreen.addEventListener('click', () => { playSound('ui_click'); winScreen.querySelectorAll('.firework, .particle').forEach(el => el.remove()); winScreen.style.display = 'none'; setupGame(); });
        document.querySelectorAll('.admin-btn').forEach(btn => btn.addEventListener('click', () => playSound('ui_click')));
        
        document.getElementById('manual-move-btn').addEventListener('click', async (e) => { const btn = e.currentTarget; if (btn.classList.contains('active')) { btn.classList.remove('active'); return; } const player = await selectTeam(); if (!player) return; btn.classList.add('active'); const clickHandler = async (e) => { const sq = e.target.closest('.square'); if (sq) { playSound('ui_click'); const squareId = sq.id === 'start-square' ? 0 : parseInt(sq.id.split('-')[1]); playerPositions[player] = squareId; updatePlayerPosition(player, true); await checkAndTriggerEvent(player); if (!await checkWinCondition(player)) {} } btn.classList.remove('active'); board.removeEventListener('click', clickHandler); }; board.addEventListener('click', clickHandler, { once: true }); });
        document.getElementById('admin-shield-btn').addEventListener('click', async () => { const p = await selectTeam(); if (!p) return; playSound('shield_gain'); playerShields[p] = true; updateShieldVisual(p); showPopup('تم!', `تم تفعيل الدرع لفريق ${p === 1 ? 'الشباب' : 'البنات'}.`, 'event'); });
        document.getElementById('admin-detector-btn').addEventListener('click', async () => { const p = await selectTeam(); if (!p) return; const pos = playerPositions[p]; let revealedHtml = 'الأحداث القادمة:<br>'; let found = false; for (let i = 1; i <= 6; i++) { const targetSq = pos + i; if (squareEvents[targetSq]) { found = true; revealedHtml += `• مربع ${targetSq}: ${squareEvents[targetSq].title}<br>`; const sqEl = document.getElementById(`square-${targetSq}`); if (sqEl) { sqEl.classList.add('revealed-event'); setTimeout(() => sqEl.classList.remove('revealed-event'), 4000); } } } if (!found) revealedHtml = 'لا توجد أحداث في الـ 6 مربعات القادمة.'; showPopup('كاشف الأحداث', revealedHtml, 'event'); });
        document.getElementById('admin-double-btn').addEventListener('click', async () => { const p = await selectTeam(); if (!p) return; playerFlags[p] = {...playerFlags[p], doubleNextSpin: true }; showPopup('تم!', `الضربة الإيجابية القادمة لفريق ${p === 1 ? 'الشباب' : 'البنات'} ستتضاعف.`, 'event'); });
        document.getElementById('admin-swap-btn').addEventListener('click', async () => { playSound('player_swap'); [playerPositions[1], playerPositions[2]] = [playerPositions[2], playerPositions[1]]; updatePlayerPosition(1); updatePlayerPosition(2); showPopup('تم!', 'تم تبديل مراكز الفريقين.', 'event'); await new Promise(r => setTimeout(r, 1500)); resultPopup.style.display = 'none'; await checkAndTriggerEvent(1); await checkAndTriggerEvent(2); });
        document.getElementById('admin-win-btn').addEventListener('click', async () => { const player = await selectTeam(); if (!player) return; const playerName = player === 1 ? 'الشباب' : 'البنات'; showPopup('حسم الجولة!', `فريق ${playerName} يفوز الآن!`, 'event'); await new Promise(resolve => setTimeout(resolve, 2500)); resultPopup.style.display = 'none'; await checkWinCondition(player, true); });

        setupGame();
    });
    </script>
</body>
</html>
